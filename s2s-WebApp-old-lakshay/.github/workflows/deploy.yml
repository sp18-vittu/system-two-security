name: Deploy to ECS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - qa
          - demo
          
jobs:
  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Set Environment Variables
        run: |
          export ENVIRONMENT="${{ github.event.inputs.environment }}"
          IMAGE_NAME="s2s-webapp"
          ECR_REPO="143364003363.dkr.ecr.us-west-2.amazonaws.com/${ENVIRONMENT}/${IMAGE_NAME}"
          CLUSTER_NAME="s2s-${ENVIRONMENT}"

          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "ECR_REPO=$ECR_REPO" >> $GITHUB_ENV
          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV

      - name: Extract Image tag with Date, Ticket ID, and Full Time
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          if [[ -n "${{ github.event.pull_request.head.sha }}" ]]; then
            COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.event.pull_request.head.sha }})
          else
            COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          fi
          TICKET_ID=$(echo "$COMMIT_MESSAGE" | grep -oE '[A-Z]+-[0-9]+'|| true)
          if [[ -n "$TICKET_ID" ]]; then
            IMAGE_TAG="${TICKET_ID}_${TIMESTAMP}"
          else
            IMAGE_TAG="${TIMESTAMP}_default-tag"
          fi
          echo "Using IMAGE_TAG: $IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
  
            # DEBUBBING OUTPUT 
          echo "Commit message: $COMMIT_MESSAGE"
          echo "Extracted Ticket ID: $TICKET_ID"
        shell: /usr/bin/bash -e {0}

      - name: Modify URLs in environment.ts
        run: |
          sed -i "s|https://\\[env\\].systemtwosecurity.com|https://s2s-service-suite.${{ env.ENVIRONMENT }}.systemtwosecurity.com|g" frontend/src/environment/environment.ts
          sed -i "s|wss://\\[env\\].systemtwosecurity.com|wss://s2s-service-suite.${{ env.ENVIRONMENT }}.systemtwosecurity.com|g" frontend/src/environment/environment.ts

      - name: Display Modified environment.ts
        run: cat frontend/src/environment/environment.ts

      - name: Echo Environment Variables
        run: |
          echo "ENVIRONMENT=${{ env.ENVIRONMENT }}"
          echo "ECR_REPO=${{ env.ECR_REPO }}"
          echo "IMAGE_TAG=${{ env.IMAGE_TAG }}"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Login to AWS ECR
        run: |
          aws ecr get-login-password --region us-west-2 | \
          docker login --username AWS --password-stdin ${{ env.ECR_REPO }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and Push ARM64 Docker Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -t ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }} \
            --push .
        env:
          DOCKER_BUILDKIT: 1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.6'

      - name: Apply Terraform Changes
        working-directory: infrastructure/terraform
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="aws_region=us-west-2" \
            -var="aws_account_id=143364003363" \
            -var="ecr_repo=${{ env.ECR_REPO }}" \
            -var="image_tag=${{ env.IMAGE_TAG }}" \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="cpu_architecture=ARM64"

      - name: Update ECS Service
        run: |
          SERVICE_NAME="webapp"
          TASK_DEFINITION_NAME="${{ env.ENVIRONMENT }}-${SERVICE_NAME}-td"
          CLUSTER_NAME="s2s-${{ env.ENVIRONMENT }}"

          TASK_DEFINITION_ARN=$(aws ecs describe-task-definition \
            --task-definition $TASK_DEFINITION_NAME \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          if [[ -z "$TASK_DEFINITION_ARN" ]]; then
            echo "Error: Failed to retrieve the task definition ARN for $TASK_DEFINITION_NAME."
            exit 1
          fi

          echo "Updating ECS service $SERVICE_NAME on cluster $CLUSTER_NAME with task definition: $TASK_DEFINITION_ARN"

          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $SERVICE_NAME \
            --task-definition $TASK_DEFINITION_ARN \
            --force-new-deployment

      - name: Clean up Workspace
        run: rm -rf *